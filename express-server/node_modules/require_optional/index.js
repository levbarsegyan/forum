var path = require('path'),
  fs = require('fs'),
  f = require('util').format,
  resolveFrom = require('resolve-from'),
  semver = require('semver');
var exists = fs.existsSync || path.existsSync;
var find_package_json = function(location) {
  var found = false;
  while(!found) {
    if (exists(location + '/package.json')) {
      found = location;
    } else if (location !== '/') {
      location = path.dirname(location);
    } else {
      return false;
    }
  }
  return location;
}
var find_package_json_with_name = function(name) {
  var currentModule = module;
  var found = false;
  while (currentModule) {
    location = currentModule.filename;
    var location = find_package_json(location)
    if (!location) {
      currentModule = currentModule.parent;
      continue;
    }
    var object = JSON.parse(fs.readFileSync(f('%s/package.json', location)));
    var parts = name.split(/\
    
    if (!object.peerOptionalDependencies || (object.peerOptionalDependencies && !object.peerOptionalDependencies[parts[0]])) {
      currentModule = currentModule.parent;
      continue;
    }
    found = true;
    break;
  }
  if (!found) {
    throw new Error(f('no optional dependency [%s] defined in peerOptionalDependencies in any package.json', parts[0]));
  }
  return {
    object: object,
    parts: parts
  }
}
var require_optional = function(name, options) {
  options = options || {};
  options.strict = typeof options.strict == 'boolean' ? options.strict : true;
  var res = find_package_json_with_name(name)
  var object = res.object;
  var parts = res.parts;
  var expectedVersions = object.peerOptionalDependencies[parts[0]];
  var moduleEntry = undefined;
  var moduleEntryFile = name;
  try {
    moduleEntry = require(moduleEntryFile);
  } catch(err) {
    try {
      moduleEntryFile = resolveFrom(process.cwd(), name);
      if(moduleEntryFile == null) return undefined;
      moduleEntry = require(moduleEntryFile);
    } catch(err) {
      if(err.code === 'MODULE_NOT_FOUND') return undefined;
    }
  }
  var location = find_package_json(require.resolve(moduleEntryFile));
  if(!location) {
    throw new Error('package.json can not be located');
  }
  var dependentOnModule = JSON.parse(fs.readFileSync(f('%s/package.json', location)));
  var version = dependentOnModule.version;
  if(semver.satisfies(version, expectedVersions) == false
    && options.strict) {
      var error = new Error(f('optional dependency [%s] found but version [%s] did not satisfy constraint [%s]', parts[0], version, expectedVersions));
      error.code = 'OPTIONAL_MODULE_NOT_FOUND';
      throw error;
  }
  return moduleEntry;
}
require_optional.exists = function(name) {
  try {
    var m = require_optional(name);
    if(m === undefined) return false;
    return true;
  } catch(err) {
    return false;
  }
}
module.exports = require_optional;
