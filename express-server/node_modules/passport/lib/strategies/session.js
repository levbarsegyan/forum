var pause = require('pause')
  , util = require('util')
  , Strategy = require('passport-strategy');
function SessionStrategy(options, deserializeUser) {
  if (typeof options == 'function') {
    deserializeUser = options;
    options = undefined;
  }
  options = options || {};
  Strategy.call(this);
  this.name = 'session';
  this._deserializeUser = deserializeUser;
}
util.inherits(SessionStrategy, Strategy);
SessionStrategy.prototype.authenticate = function(req, options) {
  if (!req._passport) { return this.error(new Error('passport.initialize() middleware not in use')); }
  options = options || {};
  var self = this, 
      su;
  if (req._passport.session) {
    su = req._passport.session.user;
  }
  if (su || su === 0) {
    var paused = options.pauseStream ? pause(req) : null;
    this._deserializeUser(su, req, function(err, user) {
      if (err) { return self.error(err); }
      if (!user) {
        delete req._passport.session.user;
      } else {
        var property = req._passport.instance._userProperty || 'user';
        req[property] = user;
      }
      self.pass();
      if (paused) {
        paused.resume();
      }
    });
  } else {
    self.pass();
  }
};
module.exports = SessionStrategy;
